<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Light Clients in Tendermint Consensus</title><meta name="description" content="Alongside the core consensus engine, we are building a large set of tooling for the Tendermint ecosystem and the Cosmos Network. Since the…"><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Light Clients in Tendermint Consensus</h1>
</header>
<section data-field="subtitle" class="p-summary">
Alongside the core consensus engine, we are building a large set of tooling for the Tendermint ecosystem and the Cosmos Network. Since the…
</section>
<section data-field="body" class="e-content">
<section name="9b34" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="6552" id="6552" class="graf graf--h3 graf--leading graf--title">Light Clients in Tendermint Consensus</h3></div><div class="section-inner sectionLayout--outsetColumn"><figure name="220d" id="220d" class="graf graf--figure graf--layoutOutsetCenter graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 563px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.3%;"></div><img class="graf-image" data-image-id="1*LudZr0hkr3-0NK_vMx36PQ.png" data-width="3840" data-height="2160" src="https://cdn-images-1.medium.com/max/1000/1*LudZr0hkr3-0NK_vMx36PQ.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="091f" id="091f" class="graf graf--p graf-after--figure">Alongside the core consensus engine, we are building a large set of tooling for the Tendermint ecosystem and the Cosmos Network. Since the release of <a href="https://github.com/tendermint/basecoin" data-href="https://github.com/tendermint/basecoin" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">basecoin</a> 0.6 in June 2017, we have a complete and working implementation of our light client protocol, which allows a client to get cryptographic proofs of the state and transactions without syncing all blocks or even all headers.</p><p name="ca88" id="ca88" class="graf graf--p graf-after--p">This gives a light client all the security of a full node with minimal bandwidth requirements. In fact, this light client protocol is so secure we can use it as the basis of <a href="https://blog.cosmos.network/developer-deep-dive-cosmos-ibc-5855aaf183fe" data-href="https://blog.cosmos.network/developer-deep-dive-cosmos-ibc-5855aaf183fe" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Cosmos IBC</a>. And the minimal bandwidth requirements allows developers to build fully secure, efficient and usable mobile apps.</p><p name="61b2" id="61b2" class="graf graf--p graf-after--p">Let us look at how other chains think about light clients before delving into how our protocol works.</p><h3 name="7004" id="7004" class="graf graf--h3 graf-after--p">How Bitcoin Verifies Transactions</h3><h4 name="9d41" id="9d41" class="graf graf--h4 graf-after--h3">Run a full node or trust the proxy:</h4><p name="128b" id="128b" class="graf graf--p graf-after--h4">If you want to participate in the network, you are expected to run a non-mining full node. Running a full node involves receiving a mined block roughly every 10 minutes and then applying the latest Unspent Transaction Outputs (UTXOs) to your local state machine.</p><p name="f1a7" id="f1a7" class="graf graf--p graf-after--p">Following the Bitcoin blockchain once a full node is synced with the network is a simple task. Over a day, a full node downloads ~120 MB of data, or about a quarter of a million simple transactions. The larger problem arises for new nodes that want to join the network and have to sync the entire blockchain after it has been running for some years. It currently takes 3–4 days with a stable and fast connection to synchronize the 135GB Bitcoin blockchain.</p><p name="86d2" id="86d2" class="graf graf--p graf-after--p">Due to the high barrier to entry for individuals to verify their own transactions, users usually rely on trusted third parties that act as gateways. Although forgery on the p2p layer is near impossible, it is possible for a trusted proxy to deceive you. This reliance on a third party fundamentally negates one of the core advantages of decentralized protocols in the first place.</p><h3 name="3778" id="3778" class="graf graf--h3 graf-after--p">How Ethereum Verifies Transactions</h3><h4 name="cf20" id="cf20" class="graf graf--h4 graf-after--h3">Just follow the headers:</h4><p name="3f56" id="3f56" class="graf graf--p graf-after--h4">Ethereum introduced many innovations to the blockchain space. The most notable was the addition of smart contracts. This allows users to upload and execute “arbitrary” code as part of the state transition. It also makes transactions much larger and more expensive to execute, as they must be run by the Ethereum Virtual Machine (EVM) and normally require more than a few atomic operations, as is the case in Bitcoin.</p><p name="11e7" id="11e7" class="graf graf--p graf-after--p">Ethereum circumvents this issue by storing the entire state in a <a href="https://github.com/ethereum/wiki/wiki/Patricia-Tree" data-href="https://github.com/ethereum/wiki/wiki/Patricia-Tree" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Patricia Tree</a>, allowing the construction of <a href="https://en.wikipedia.org/wiki/Merkle_tree" data-href="https://en.wikipedia.org/wiki/Merkle_tree" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Merkle proofs</a>, which trace any key-value pair in the store with only a few KB. This root hash is stored in the block header. Given a proper block header, a client can <a href="https://www.certificate-transparency.org/log-proofs-work" data-href="https://www.certificate-transparency.org/log-proofs-work" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">verify any key-value pair</a> in the corresponding block. Thus, an <a href="https://github.com/ethereum/wiki/wiki/Light-client-protocol" data-href="https://github.com/ethereum/wiki/wiki/Light-client-protocol" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Ethereum light client</a> just has to synchronize and verify all headers in the blockchain. Then a client can query any key in the current state. Furthermore it is able to verify the result of the query without having to run a single transaction or trust any node.</p><p name="fce6" id="fce6" class="graf graf--p graf-after--p">Even though it is a major step forward, it still involves downloading all headers, which is a non-trivial amount of data.</p><h3 name="ef8d" id="ef8d" class="graf graf--h3 graf-after--p">How Tendermint Verifies Transactions</h3><h4 name="5fa5" id="5fa5" class="graf graf--h4 graf-after--h3">Just follow the validator changes:</h4><p name="43c4" id="43c4" class="graf graf--p graf-after--h4">Tendermint, like Ethereum, stores a Merkle root hash in each block header to prove its state in an efficient manner. Although Tendermint uses a slightly different data structure (an <a href="https://github.com/tendermint/merkleeyes/tree/master/iavl" data-href="https://github.com/tendermint/merkleeyes/tree/master/iavl" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">IAVL+ tree</a> rather than a Patricia Tree), the effect is similar. If a client has a correct header, then it can verify any key-value pair for a block at that height.</p><p name="e935" id="e935" class="graf graf--p graf-after--p">The difference is that with Tendermint’s throughput of 1 block per second, even following the headers can become a time-consuming task, especially if a client does not have a persistent connection. For example, you might turn off your phone while sleeping and when you turn it back on you must download 30,000 headers. However, there is an elegant solution which is tied to Tendermint’s instant finality property (meaning it never forks).</p><p name="03e9" id="03e9" class="graf graf--p graf-after--p">Using a Byzantine fault-tolerant consensus algorithm, Tendermint achieves instant <a href="https://blog.ethereum.org/2016/05/09/on-settlement-finality/" data-href="https://blog.ethereum.org/2016/05/09/on-settlement-finality/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">finality</a>. As long as less than two-thirds of the validators are malicious, a client can trust any header that is signed by a known validator set (VS). If the VS is static, a client only has to securely receive the genesis file with the static VS and can then check the signatures of any header. If the header was signed by over two-thirds of the static VS, the client can be certain that it is a valid block that has been included in the chain.</p><p name="16ed" id="16ed" class="graf graf--p graf-after--p">The validator set in the Cosmos Network is not static but rather changes over time as new validators receive a larger economic stake or old validators are punished. With a dynamic validator set, a client has to keep track of the changes to the validator set. For this reason, any time there is a change in that set, the client has to download a new header, verify the validator set change is valid, and update the local validator set. The Tendermint Proof-of-Stake algorithm introduces a four week unbonding period in order to avoid long-range nothing-at-stake attacks. This means that as long as the last trusted header was more recent than the unbonding period, a client is secure.</p><p name="5fe0" id="5fe0" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Real world example — how changing the validator set works:</strong></p><p name="8f6b" id="8f6b" class="graf graf--p graf-after--p">If there are 10 validators that a client trusts on block A, and only 9 of those validators signed block B, a client is certain that it was a valid change, since a super-majority (&gt; ⅔) of the validators that the client trusted before this block, signed it. If the current block was signed by only 6 of the trusted validators (from the previous block) along with 4 completely new validators, the client will reject this block as invalid as it has not been signed by a super-majority (less than two-thirds). In Tendermint, as in any other BFT algorithm, over two-thirds of the validating nodes have to be honest. If an attacker controls over two-thirds, they can fool anyone, including full nodes.</p><p name="2e94" id="2e94" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Real world example — how a light client works in practice:</strong></p><p name="dcb9" id="dcb9" class="graf graf--p graf-after--p">On Friday evening your phone has a snapshot of the currently trusted set of validators. You decide to turn it off for the night. On Saturday morning your phone connects again. In this stage, your client only has to download the most recent header, which is about 2KB. If the validator set did not change overnight, or if it did change, but only by less than one-third of the total from the previous set, your phone will immediately trust the new set. At this point, your phone can verify any state from the blockchain as described above (proof of state and transactions) and can interact with the blockchain in a fully secure manner. Very notably, you just skipped over Ethereum’s requirement of downloading and validating 30,000 intervening block headers.</p><p name="8280" id="8280" class="graf graf--p graf-after--p">If the validator set did change considerably in the time a client was offline, it still does not have to download all headers. Instead, it can find a path of intermediate headers. The requirement for this path for any two consecutive headers is that the validator set changes by less than one-third.</p><p name="4faa" id="4faa" class="graf graf--p graf-after--p">At 06:00 the validator set consists of validators A, B, C, D. At 09:00 the validator set consists of validators A, B, C, E.<br>At 12:00 the validator set consists of validators A, B, E, F.</p><p name="f3d3" id="f3d3" class="graf graf--p graf-after--p">A light-client (phone) trusts the validator set at 06:00 (A, B, C, D) (for example by manually checking that it is correct). It now goes offline and only comes back at 12:00. It will receive the new validator set (A, B, E, F). Here 50% changed which is an unsafe change, because the light-client cannot verify that &gt;2/3 of the validators it trust (from the set at 06:00) signed off on that change. This means that it might have received a byzantine packet.</p><p name="de37" id="de37" class="graf graf--p graf-after--p">The phone however can ask for an earlier header (from 09:00). Here the validator set (A, B, C, E) has changed by &lt;1/3. This is a trusted change in the validator set and the phone now has an updated trusted validator set( A, B, C, E). From here it can update to the most recent validator set (A, B, E, F), because between ABCE and ABEF is &lt;1/3 change.</p><p name="9775" id="9775" class="graf graf--p graf-after--p">Overall, the change in the validator set can be much larger. This shows that even if there are large changes in the validator set, a light client still only has to do a minimal amount of work in order to securely update its validator set.</p><h4 name="c9ab" id="c9ab" class="graf graf--h4 graf-after--p"><strong class="markup--strong markup--h4-strong">Tendermint — From Theory to Practice</strong></h4><p name="599d" id="599d" class="graf graf--p graf-after--h4 graf--trailing">As of <a href="https://github.com/tendermint/basecoin/tree/v0.6.2" data-href="https://github.com/tendermint/basecoin/tree/v0.6.2" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">basecoin 0.6</a>, Tendermint ships with a fully functional <a href="https://github.com/tendermint/light-client" data-href="https://github.com/tendermint/light-client" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">light client</a>. Basecoin is the server, and basecli is a client designed for your laptop. If you want to <a href="https://blog.cosmos.network/introducing-basecoin-testnets-96d5f9e52e1f" data-href="https://blog.cosmos.network/introducing-basecoin-testnets-96d5f9e52e1f" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">connect to the testnet</a>, you will have to initialize the client one time with the trusted validator set (from the genesis file). After that, it will automatically update itself and ask for all the proofs it needs to verify any information it receives from a node. If the node gives an invalid proof, it will present an error.</p></div></div></section><section name="8aee" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="3548" id="3548" class="graf graf--p graf--leading graf--trailing">Got questions? Ask them in <a href="http://riot.im" data-href="http://riot.im" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Riot Chat</a> (channel: #cosmos:matrix.org)</p></div></div></section>
</section>
<footer><p class="p-tags">Tagged in <a href="https://medium.com/tag/blockchain" class="p-tag">Blockchain</a>, <a href="https://medium.com/tag/tendermint" class="p-tag">Tendermint</a>, <a href="https://medium.com/tag/cryptocurrency" class="p-tag">Cryptocurrency</a>, <a href="https://medium.com/tag/bitcoin" class="p-tag">Bitcoin</a>, <a href="https://medium.com/tag/ethereum" class="p-tag">Ethereum</a></p><p>By <a href="https://medium.com/@ethan.frey" class="p-author h-card">Ethan Frey</a> on <a href="https://medium.com/p/1237cfbda104"><time class="dt-published" datetime="2017-10-11T04:43:45.974Z">October 11, 2017</time></a>.</p><p><a href="https://medium.com/@ethan.frey/light-clients-in-tendermint-consensus-1237cfbda104" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on April 23, 2018.</p></footer></article>

</body></html>