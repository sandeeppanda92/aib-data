<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Abstracting the logger interface in Go</title><meta name="description" content="This article describes the evolution of logging in Tendermint. By Anton Kaliaev"><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Abstracting the logger interface in Go</h1>
</header>
<section data-field="subtitle" class="p-summary">
This article describes the evolution of logging in Tendermint. By Anton Kaliaev
</section>
<section data-field="body" class="e-content">
<section name="016c" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="0e76" id="0e76" class="graf graf--h3 graf--leading graf--title">Abstracting the logger interface in Go</h3><h4 name="006d" id="006d" class="graf graf--h4 graf-after--h3 graf--subtitle">This article describes the evolution of logging in Tendermint. By <a href="https://twitter.com/akaliaev" data-href="https://twitter.com/akaliaev" class="markup--anchor markup--h4-anchor" rel="noopener" target="_blank">Anton Kaliaev</a></h4><p name="f7bc" id="f7bc" class="graf graf--p graf-after--h4">This article describes the evolution of logging in Tendermint. We went from having a static <a href="https://github.com/inconshreveable/log15/" data-href="https://github.com/inconshreveable/log15/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">log15</a> logger to a transparent interface and implementation that uses <a href="https://github.com/go-kit/kit/tree/master/log" data-href="https://github.com/go-kit/kit/tree/master/log" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">go-kit’s log</a> package under the hood, but can be easily swapped with any other available package.</p><h3 name="9339" id="9339" class="graf graf--h3 graf-after--p">The old way</h3><p name="f40c" id="f40c" class="graf graf--p graf-after--h3">We were using package level log variables to set the logger for each package. For instance, for the <code class="markup--code markup--p-code">mempool</code> package:</p><figure name="0d54" id="0d54" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/0b8da54cbc07ad478ab1d39348f46fc2.js"></script></figure><p name="8489" id="8489" class="graf graf--p graf-after--figure">Here, <code class="markup--code markup--p-code">logger.New</code> returns “something” with a <code class="markup--code markup--p-code">log15.Logger</code> interface.</p><p name="625c" id="625c" class="graf graf--p graf-after--p">Although it was simple and required almost no time to setup, this approach has some downsides:</p><ol class="postList"><li name="3aaa" id="3aaa" class="graf graf--li graf-after--p">Tight coupling between the <code class="markup--code markup--li-code">mempool</code> and <code class="markup--code markup--li-code">logger</code> packages. The <code class="markup--code markup--li-code">mempool</code> package now directly depends on <code class="markup--code markup--li-code">logger</code> at compile time. Also, it’s transitive, which means that any package that consumes <code class="markup--code markup--li-code">mempool</code> is itself dependent on <code class="markup--code markup--li-code">logger</code> at compile time. Read <a href="https://dave.cheney.net/2017/01/23/the-package-level-logger-anti-pattern" data-href="https://dave.cheney.net/2017/01/23/the-package-level-logger-anti-pattern" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Dave Chaney’s post</a> for details.</li><li name="953a" id="953a" class="graf graf--li graf-after--li">Even though <code class="markup--code markup--li-code">log15</code> is hidden inside the <code class="markup--code markup--li-code">logger</code> package, we are using its interface. When we decided to make changes to the interface, we had to fork the <code class="markup--code markup--li-code">logger</code> repo.</li><li name="7e6e" id="7e6e" class="graf graf--li graf-after--li">If somebody wanted to change the log level just for that package, they would need to uncomment the <code class="markup--code markup--li-code">init</code> function. This did not scale very well, as you can imagine.</li><li name="4c5c" id="4c5c" class="graf graf--li graf-after--li">There is no way to implement custom coloring when using <code class="markup--code markup--li-code">log15</code> (for example, if I want different colors depending on whenever key-values contain <code class="markup--code markup--li-code">err</code> key)</li></ol><h3 name="c2b3" id="c2b3" class="graf graf--h3 graf-after--li">The new way</h3><h4 name="14d5" id="14d5" class="graf graf--h4 graf-after--h3">Our own interface</h4><p name="822a" id="822a" class="graf graf--p graf-after--h4">We started by creating an interface:</p><figure name="1fac" id="1fac" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/b3f576cbdae03d4989e37be7227c0895.js"></script></figure><p name="e36c" id="e36c" class="graf graf--p graf-after--figure">It is very simple and does not tie us to any existing logging package. Also, we wanted to avoid having many log levels, as many people advocate against it:</p><blockquote name="05f0" id="05f0" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">Avoid fine-grained log levels — info and debug are probably enough (</em><a href="https://peter.bourgon.org/go-best-practices-2016/#logging-and-instrumentation" data-href="https://peter.bourgon.org/go-best-practices-2016/#logging-and-instrumentation" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank"><em class="markup--em markup--blockquote-em">Peter Bourgon</em></a><em class="markup--em markup--blockquote-em">)</em></blockquote><blockquote name="8419" id="8419" class="graf graf--blockquote graf-after--blockquote"><em class="markup--em markup--blockquote-em">Nobody needs a warning log level. (</em><a href="https://dave.cheney.net/2015/11/05/lets-talk-about-logging" data-href="https://dave.cheney.net/2015/11/05/lets-talk-about-logging" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank"><em class="markup--em markup--blockquote-em">Dave Cheney</em></a><em class="markup--em markup--blockquote-em">)</em></blockquote><p name="51ce" id="51ce" class="graf graf--p graf-after--blockquote">This fixed the second issue (<code class="markup--code markup--p-code">log15</code> interface).</p><h4 name="fa49" id="fa49" class="graf graf--h4 graf-after--p">Writing an adapter for the interface</h4><p name="19ad" id="19ad" class="graf graf--p graf-after--h4">Then we proceeded by picking a logging library and implementing an adapter.</p><p name="8ee4" id="8ee4" class="graf graf--p graf-after--p">The requirements for the logging library were as follows:</p><p name="6cca" id="6cca" class="graf graf--p graf-after--p">a) supports coloring output b) is moderately fast (buffering) c) is somewhat configurable</p><p name="ae2b" id="ae2b" class="graf graf--p graf-after--p">In the end, we were choosing between <a href="https://github.com/sirupsen/logrus" data-href="https://github.com/sirupsen/logrus" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">logrus</a> and <a href="https://github.com/go-kit/kit/tree/master/log" data-href="https://github.com/go-kit/kit/tree/master/log" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">go-kit/log</a>.</p><p name="41f7" id="41f7" class="graf graf--p graf-after--p"><code class="markup--code markup--p-code">go-kit/log</code> is flexible and modular, but the default formatter uses <code class="markup--code markup--p-code"><a href="https://brandur.org/logfmt" data-href="https://brandur.org/logfmt" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">logfmt</a></code><a href="https://brandur.org/logfmt" data-href="https://brandur.org/logfmt" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"> format</a>, which is more computer friendly than human friendly.</p><p name="fcd8" id="fcd8" class="graf graf--p graf-after--p"><code class="markup--code markup--p-code">logrus</code> is popular and feature rich, but not as flexible.</p><p name="1c99" id="1c99" class="graf graf--p graf-after--p">Some people say having too many features is bad:</p><blockquote name="1ad4" id="1ad4" class="graf graf--blockquote graf-after--p"><em class="markup--em markup--blockquote-em">I want to take a contradictory position. I think that all logging libraries are bad because the offer too many features; a bewildering array of choice that dazzles the programmer right at the point they must be thinking clearly about how to communicate with the reader from the future; the one who will be consuming their logs. (</em><a href="https://dave.cheney.net/2015/11/05/lets-talk-about-logging" data-href="https://dave.cheney.net/2015/11/05/lets-talk-about-logging" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank"><em class="markup--em markup--blockquote-em">Dave Cheney</em></a><em class="markup--em markup--blockquote-em">)</em></blockquote><p name="f035" id="f035" class="graf graf--p graf-after--blockquote">So we chose <code class="markup--code markup--p-code">go-kit/log</code>.</p><figure name="1d36" id="1d36" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/46e421b661789ce8aa64ca3144a0d68d.js"></script></figure><p name="c9c8" id="c9c8" class="graf graf--p graf-after--figure">The full code can be found on <a href="https://github.com/tendermint/tmlibs/tree/master/log" data-href="https://github.com/tendermint/tmlibs/tree/master/log" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Github</a>.</p><p name="5609" id="5609" class="graf graf--p graf-after--p">The code is self explanatory. We implement our interface by proxying to the underlying logger (<code class="markup--code markup--p-code">srcLogger</code>) with level and message keys prepended to keyvals.</p><p name="0556" id="0556" class="graf graf--p graf-after--p">TMFmtFormatter’s format is very similar to <a href="https://brandur.org/logfmt" data-href="https://brandur.org/logfmt" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">logfmt</a>, except it gives the level, timestamp and message a special treatment. We inherited this format from <a href="https://github.com/inconshreveable/log15/" data-href="https://github.com/inconshreveable/log15/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">log15</a>. It provides a nice balance between readability and computer friendliness.</p><figure name="1da9" id="1da9" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/a364e9c4a74d76b2c620234d99c9f25e.js"></script></figure><p name="1d9a" id="1d9a" class="graf graf--p graf-after--figure">The new scheme enabled us to remove all our <code class="markup--code markup--p-code">log.go</code> files, but required us to add <code class="markup--code markup--p-code">log log.Logger</code> fields to the structs that do any logging. This was a worth-while trade-off, since it relieves the tight-coupling (ie. the first issue mentioned earlier).</p><h3 name="0b04" id="0b04" class="graf graf--h3 graf-after--p">Log levels per package</h3><p name="9d49" id="9d49" class="graf graf--p graf-after--h3">First, we implemented generic filtering based on <a href="https://github.com/go-kit/kit/blob/master/log/level/level.go#L25" data-href="https://github.com/go-kit/kit/blob/master/log/level/level.go#L25" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">go-kit/log filter</a>. Then, we added a few new options:</p><ul class="postList"><li name="2579" id="2579" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">AllowDebugWith</code></li><li name="4875" id="4875" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">AllowInfoWith</code></li><li name="bf98" id="bf98" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">AllowErrorWith</code></li><li name="dd03" id="dd03" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">AllowNoneWith</code></li></ul><figure name="0b3a" id="0b3a" class="graf graf--figure graf--iframe graf-after--li"><script src="https://gist.github.com/cf24a69b5ffda7b0e66a992e7e91aa99.js"></script></figure><p name="476a" id="476a" class="graf graf--p graf-after--figure">The API is straightforward and easy to understand. In the example above, we are saying: “use info level if key-values contain “module/crypto” pair; otherwise, use error level”.</p><p name="076e" id="076e" class="graf graf--p graf-after--p">That said, there are some corner cases, which we describe <a href="https://github.com/tendermint/tmlibs/blob/master/log/filter.go#L73" data-href="https://github.com/tendermint/tmlibs/blob/master/log/filter.go#L73" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">here</a>.</p><h3 name="1f98" id="1f98" class="graf graf--h3 graf-after--p">Custom coloring</h3><p name="8383" id="8383" class="graf graf--p graf-after--h3">Custom coloring is easy with <code class="markup--code markup--p-code">go-kit/log</code>. The only thing you need is to provide the coloring function:</p><figure name="35c7" id="35c7" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/056fb16f1886ef2f1ccf33432fdb1e47.js"></script></figure><p name="bc96" id="bc96" class="graf graf--p graf-after--figure">There are many other things you can do with such adapters. If you are curious, here is how we <a href="https://github.com/tendermint/tmlibs/blob/master/log/tmfmt_logger.go" data-href="https://github.com/tendermint/tmlibs/blob/master/log/tmfmt_logger.go" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">implemented our own formatter</a>. Also, it is a nice thing to have a <a href="https://github.com/tendermint/tmlibs/blob/master/log/nop_logger.go" data-href="https://github.com/tendermint/tmlibs/blob/master/log/nop_logger.go" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">nil logger (or nop logger)</a> to discard the output.</p><h3 name="09f4" id="09f4" class="graf graf--h3 graf-after--p">Conclusion</h3><p name="001a" id="001a" class="graf graf--p graf-after--h3">By replacing the old static logging system with a new abstract interface and adapter, we archived greater flexibility, lower coupling (one could use Tendermint’s package and their own logger, if it conforms to our interface) and avoided vendor lock-in (we now can swap the implementations very easily).</p><p name="f684" id="f684" class="graf graf--p graf-after--p graf--trailing">Thanks to the new implementation we now have consensus tests where each instance has its own color, smart <code class="markup--code markup--p-code">--log_level</code> flag which allows disabling output for one package and allowing some level for others. Stay tuned for more updates!</p></div></div></section><section name="11ca" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="16b0" id="16b0" class="graf graf--p graf--leading graf--trailing"><em class="markup--em markup--p-em">Originally published at </em><a href="https://gist.github.com/63a0524759e786d40e92d6f964847e25" data-href="https://gist.github.com/63a0524759e786d40e92d6f964847e25" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><em class="markup--em markup--p-em">gist.github.com</em></a><em class="markup--em markup--p-em">.</em></p></div></div></section>
</section>
<footer><p class="p-tags">Tagged in <a href="https://medium.com/tag/golang" class="p-tag">Golang</a>, <a href="https://medium.com/tag/tendermint" class="p-tag">Tendermint</a>, <a href="https://medium.com/tag/logging" class="p-tag">Logging</a>, <a href="https://medium.com/tag/mempool" class="p-tag">Mempool</a>, <a href="https://medium.com/tag/consensus" class="p-tag">Consensus</a></p><p>By <a href="https://medium.com/@nylira" class="p-author h-card">Peng Zhong</a> on <a href="https://medium.com/p/4cf96bf90bb7"><time class="dt-published" datetime="2017-05-30T07:00:00.000Z">May 30, 2017</time></a>.</p><p><a href="https://medium.com/@nylira/abstracting-the-logger-interface-in-go-4cf96bf90bb7" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on April 23, 2018.</p></footer></article>

</body></html>