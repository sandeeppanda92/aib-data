<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>The Technicals of Interoperability—Introducing the Ethereum Peg Zone</title><meta name="description" content="A high level technical overview of the inner workings of Cosmos and how it builds the Internet of Blockchains."><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">The Technicals of Interoperability—Introducing the Ethereum Peg Zone</h1>
</header>
<section data-field="subtitle" class="p-summary">
A high level technical overview of the inner workings of Cosmos and how it builds the Internet of Blockchains.
</section>
<section data-field="body" class="e-content">
<section name="bded" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="4b73" id="4b73" class="graf graf--h3 graf--leading graf--title">The Technicals of Interoperability—Introducing the Ethereum Peg Zone</h3></div><div class="section-inner sectionLayout--outsetColumn"><figure name="54c5" id="54c5" class="graf graf--figure graf--layoutOutsetCenter graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 1000px; max-height: 563px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.3%;"></div><img class="graf-image" data-image-id="1*ju-0M4pQW1OdpwVI9OFFvw.png" data-width="3840" data-height="2160" src="https://cdn-images-1.medium.com/max/1000/1*ju-0M4pQW1OdpwVI9OFFvw.png"></div></figure></div><div class="section-inner sectionLayout--insetColumn"><p name="f316" id="f316" class="graf graf--p graf-after--figure">Cross-blockchain crypto-asset transfer is core of what we do at Cosmos. Within the ecosystem, crypto-assets are transferred via the IBC protocol, an <a href="https://blog.cosmos.network/developer-deep-dive-cosmos-ibc-5855aaf183fe" data-href="https://blog.cosmos.network/developer-deep-dive-cosmos-ibc-5855aaf183fe" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Inter-Blockchain Communication protocol</a>, which facilitates interoperability. Notably, IBC only works if both the starting and the destination chains have settlement finality.</p><p name="2ee9" id="2ee9" class="graf graf--p graf-after--p">Fortunately or unfortunately, neither Bitcoin nor Ethereum have finality guarantees; rather, they have probabilistic finality. [Edit: <em class="markup--em markup--p-em">for now</em> Ethereum doesn’t benefit from the property of finality; until, that is, <a href="https://blog.cosmos.network/consensus-compare-casper-vs-tendermint-6df154ad56ae" data-href="https://blog.cosmos.network/consensus-compare-casper-vs-tendermint-6df154ad56ae" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Casper the Friendly Finality Gadget (FFG)</a> is implemented in the near-term future.] What this means is, the deeper down the chain a block is, the less likely the chain it’s on will get reorganized, giving you a high level of confidence that the block is “final”. But because probabilistic guarantees do not protect against reorgs, transferring assets securely across chains via IBC is impossible. This prompts the question: How can Cosmos zones interoperate with pre-existing blockchains absent finality?</p><h3 name="1209" id="1209" class="graf graf--h3 graf-after--p">Peg Zones</h3><figure name="4488" id="4488" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 394px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.3%;"></div><img class="graf-image" data-image-id="1*x3Hgx-SjXTWEU9qIZ9Myrw.png" data-width="3840" data-height="2160" src="https://cdn-images-1.medium.com/max/800/1*x3Hgx-SjXTWEU9qIZ9Myrw.png"></div></figure><p name="d57d" id="d57d" class="graf graf--p graf-after--figure">Peg zones are our solution. A peg zone is an account-based blockchain which bridges zones within Cosmos to external chains like Bitcoin or Ethereum. It acts as an adaptor zone — or a “finality gadget”, in <a href="https://blog.cosmos.network/consensus-compare-casper-vs-tendermint-6df154ad56ae?gi=7466e441a70a" data-href="https://blog.cosmos.network/consensus-compare-casper-vs-tendermint-6df154ad56ae?gi=7466e441a70a" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Casper-speak</a> — which translates finality for probabilistically finalized blockchains by imposing a “finality threshold” at some arbitrary number of blocks to achieve pseudo-finality. Generally, this “translator” zone design can be classified as a 2-way peg (2WP).</p><blockquote name="e38c" id="e38c" class="graf graf--blockquote graf-after--p graf--trailing">Consensus engines such as <a href="https://github.com/tendermint/tendermint" data-href="https://github.com/tendermint/tendermint" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank">Tendermint Core</a> offer settlement finality. To better understand how it works, please read more about <a href="https://tendermint.readthedocs.io/en/master/" data-href="https://tendermint.readthedocs.io/en/master/" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank">Tendermint Consensus</a>.</blockquote></div></div></section><section name="4015" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="37c1" id="37c1" class="graf graf--h3 graf--leading">Connecting to Ethereum</h3><p name="3457" id="3457" class="graf graf--p graf-after--h3">An Ethereum peg zone is the first of its kind that we will be implementing in Cosmos. This is very different from <a href="https://blog.cosmos.network/a-beginners-guide-to-ethermint-38ee15f8a6f4" data-href="https://blog.cosmos.network/a-beginners-guide-to-ethermint-38ee15f8a6f4" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Ethermint</a>, which is the EVM, stripped of Proof-of-Work mining, then layered on top of Tendermint’s consensus and networking protocol stacks. The Ethereum peg zone will enable the movement of ERC20 tokens and Ether between the canonical Ethereum chain and all IBC-connected zones within the Cosmos Network.</p><p name="49d8" id="49d8" class="graf graf--p graf-after--p">The specifications for the peg zone are still being ironed out but you can follow the progress in the peg zone repository, codenamed <code class="markup--code markup--p-code">peggy</code>, linked below.</p><ul class="postList"><li name="b0a6" id="b0a6" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">Cosmos GitHub</strong>: (<a href="https://github.com/cosmos/peggy" data-href="https://github.com/cosmos/peggy" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">Peggy</a>)</li></ul><h4 name="2aa8" id="2aa8" class="graf graf--h4 graf-after--li">Peggy</h4><p name="1ee1" id="1ee1" class="graf graf--p graf-after--h4">In Cosmos, interoperability is easy because we can use the IBC protocol to transfer any crypto-asset. To transfer crypto-assets between Cosmos and Ethereum, however, is very technically complex because IBC packets cannot be efficiently decoded in Ethereum, simply because the EVM isn’t designed to be IBC-compatible. That is, until we implement Peggy.</p><p name="b309" id="b309" class="graf graf--p graf-after--p">Peggy had a rough start. The first construction that attempted to connect Cosmos to Ethereum was a hackathon project called <a href="https://blog.cosmos.network/etgate-md-6a31f049a62f" data-href="https://blog.cosmos.network/etgate-md-6a31f049a62f" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">ETGate</a>, which turned out to be a gas guzzler. It was designed by <a href="https://medium.com/u/b2a7c4f32e7d" data-href="https://medium.com/u/b2a7c4f32e7d" data-anchor-type="2" data-user-id="b2a7c4f32e7d" data-action-value="b2a7c4f32e7d" data-action="show-user-card" data-action-type="hover" class="markup--user markup--p-user" target="_blank">Joon</a>, the <a href="https://blog.cosmos.network/developer-showcase-hackatom-2-winner-etgate-joon-aka-mossid-1457df78589b" data-href="https://blog.cosmos.network/developer-showcase-hackatom-2-winner-etgate-joon-aka-mossid-1457df78589b" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">HackAtom 2</a> grand prize winner, who we ended up hiring to implement what is now Peggy.</p><p name="1687" id="1687" class="graf graf--p graf-after--p">ETGate initially was a direct bridge between the Cosmos Hub and Ethereum which attempted to translate compatibility within the EVM itself. Like so:</p><p name="066e" id="066e" class="graf graf--p graf-after--p"><code class="markup--code markup--p-code">[ Ethereum ] &lt;- ETGate -&gt; [ Cosmos Hub ]</code></p><p name="a140" id="a140" class="graf graf--p graf-after--p">This design was highly impractical when confronted with the problem of the different building blocks used in Tendermint and Ethereum. Every primitive used in Tendermint is fundamentally different than that of Ethereum’s. Translating those incompatibilities into compatible, interpretable building blocks inside the EVM, it turns out, is incredibly gas costly.</p><p name="06b3" id="06b3" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Here’s the breakdown of those building blocks:</strong></p><ul class="postList"><li name="d0f5" id="d0f5" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">Serialization formats</strong>. Tendermint’s encoding method to serialize objects is go-wire. Ethereum serializes objects using RLP (Recursive Length Prefix).</li><li name="d4e7" id="d4e7" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Signature schemes</strong>. Tendermint uses ed25519 whereas Ethereum uses secp256k1.</li><li name="5983" id="5983" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Data structures</strong>. Tendermint stores key-values in IAVL+ trees while Ethereum stores them in Patricia Tries.</li></ul><p name="f924" id="f924" class="graf graf--p graf-after--li">ETGate’s design was computationally expensive because it decoded IBC packets within the EVM, of which the contents were Tendermint’s headers, transactions, IAVL+ tree proofs, and ed25519 signatures.</p><p name="dfcb" id="dfcb" class="graf graf--p graf-after--p">The moment of clarity that led to the evolution of Peggy came from the realization that we could save significant amounts of gas by taking the translation mechanism out of the EVM and onto its own blockchain designed for this specific application.</p><h4 name="f0f0" id="f0f0" class="graf graf--h4 graf-after--p">Peggy’s 5 Components:</h4><figure name="839d" id="839d" class="graf graf--figure graf-after--h4"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 394px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 56.3%;"></div><img class="graf-image" data-image-id="1*iqTDUUcEO40-xwTnYKdWVA.png" data-width="3840" data-height="2160" src="https://cdn-images-1.medium.com/max/800/1*iqTDUUcEO40-xwTnYKdWVA.png"></div></figure><ol class="postList"><li name="4143" id="4143" class="graf graf--li graf-after--figure"><strong class="markup--strong markup--li-strong">Ethereum Smart Contracts</strong>: There will be a set of Ethereum smart contracts acting as asset custodians, capable of taking custody of Ethereum native tokens and issuing Cosmos native tokens.</li><li name="03cc" id="03cc" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Witness</strong>: The witness component attests witness to events in Ethereum. It waits for 100 blocks, the finality threshold, and implements this pseudo-finality over the non-finality chain. It runs a fully validating Ethereum node in order to attest to state changes within Ethereum by submitting a <code class="markup--code markup--li-code">WitnessTX</code> to the peg zone. We use a shared security model here by taking the set of Cosmos Hub validators also to be peg zone Witnesses.</li><li name="e0e6" id="e0e6" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Peg zone</strong>: The peg zone is a translator blockchain, built on Tendermint, that allows users to perform and query transactions. This is how Cosmos communicates with Ethereum.</li><li name="5b16" id="5b16" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Signer</strong>: The signer signs messages using the secp256k1 signature scheme which Ethereum understands to make signatures efficiently verifiable by smart contracts. The signer component generates secp256k1 signatures via the <code class="markup--code markup--li-code">SignTx</code> message and posts it to the peg zone for relaying transactions for validation in the smart contract down the pipeline.</li><li name="5c5c" id="5c5c" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Relayer</strong>: The relayer component relays a batched list (array) of transactions—signed by the Signer component—and posts them to the Ethereum smart contract.</li></ol><h3 name="098f" id="098f" class="graf graf--h3 graf-after--li">Tying it All Together</h3><h4 name="3963" id="3963" class="graf graf--h4 graf-after--h3">Real World Example: Moving a Cosmos native token→Ethereum</h4><p name="9f5f" id="9f5f" class="graf graf--p graf-after--h4">Let’s say, for example, you want to move some quantity of Photons out of Cosmos and convert them to Ether of equal value on Ethereum. How would this work using Peggy? For simplicity’s sake, we’ll gloss over the low-level technical details and just describe the high-level flow.</p><ol class="postList"><li name="53b0" id="53b0" class="graf graf--li graf-after--p">You start at the Cosmos Hub. You move Photons via IBC to the peg zone. The peg zone receives an incoming IBC packet: a message containing a transaction for sending Photons. Signers monitoring the peg zone then sign those IBC transactions, effectively converting the signature scheme to Ethereum-understandable private keys, in secp256k1 format. Your transaction has just been signed on the peg zone.</li><li name="682d" id="682d" class="graf graf--li graf-after--li">Relayers watching the peg zone are waiting until they see that +2/3 signers have signed the transaction before batching your signed transaction into a list of all the other transactions sent through IBC. They then relay the signature-appended list to the EVM where the Ethereum smart contract lives.</li><li name="a3d1" id="a3d1" class="graf graf--li graf-after--li">The Ethereum smart contract now checks that the list of transactions are valid. For your Photons, the smart contract needs to generate an ERC20 version of it. After the smart contract generates ERC20 Photons, it then sends the ERC20 Photons to your destination address in Ethereum.</li><li name="d628" id="d628" class="graf graf--li graf-after--li graf--trailing">At this point, converting your ERC20 Photons to ETH is as simple as using an ERC20 decentralized exchange (DEX) like the 0x protocol or OmiseGO.</li></ol></div></div></section><section name="9297" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="b836" id="b836" class="graf graf--h3 graf--leading">In Closing</h3><p name="d25f" id="d25f" class="graf graf--p graf-after--h3">We are currently prototyping a very early-stage Peggy design. The Ethereum smart contract component is already written and is currently being tested. In many ways, Peggy is even more technically complex than the Cosmos Hub itself and will take several iterations before we get it right. Cosmonauts can expect Peggy to go live sometime mid to late summer, well after mainnet launch. We understand that a lot is at stake and the need for scalability solutions, increased throughput, and decreased gas costs is important for Ethereum-based projects. Therefore, the deployment of Peggy is high priority and the Cosmos/Tendermint team has devoted a significant portion of its resources to its development in tandem with the rest of our ecosystem projects.</p><h4 name="ea29" id="ea29" class="graf graf--h4 graf-after--p">Ongoing Work</h4><p name="e5f2" id="e5f2" class="graf graf--p graf-after--h4 graf--trailing">Ethereum smart contracts, once deployed, are immutable and therefore very difficult to update. There is a lack of organizational structure around <a href="https://github.com/ethereum/wiki/wiki/White-Paper#decentralized-autonomous-organizations" data-href="https://github.com/ethereum/wiki/wiki/White-Paper#decentralized-autonomous-organizations" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">governing smart contract upgrades</a>. The development roadmap for Peggy compels us to confront this uncertainty but it’s an an area of research we hope will spawn concrete solutions.</p></div></div></section><section name="6915" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="9fe7" id="9fe7" class="graf graf--p graf--leading">[March 7, 2018 Edit]</p><p name="c0ed" id="c0ed" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Regarding security</strong>. The Signer component will be the same shared set of Cosmos Validators securing the Cosmos Hub, so what we have is an accountable peg zone with the same safety guarantees as the hub itself. For a double spend attack to occur while a transaction is in flight between the Ethereum main chain and the peg zone, there must be &gt;2/3 of the voting power taken from hostile validators.</p><p name="8160" id="8160" class="graf graf--p graf-after--p graf--trailing"><strong class="markup--strong markup--p-strong">Regarding reorgs on the Ethereum main chain</strong>. In the event that a reorg occurs on the Ethereum chain past the finality threshold on the peg zone, we defer to governance for recovery.</p></div></div></section>
</section>
<footer><p class="p-tags">Tagged in <a href="https://medium.com/tag/blockchain" class="p-tag">Blockchain</a>, <a href="https://medium.com/tag/cryptocurrency" class="p-tag">Cryptocurrency</a>, <a href="https://medium.com/tag/ethereum" class="p-tag">Ethereum</a>, <a href="https://medium.com/tag/smart-contracts" class="p-tag">Smart Contracts</a>, <a href="https://medium.com/tag/technical" class="p-tag">Technical</a></p><p>By <a href="https://medium.com/@chjango" class="p-author h-card">Chjango Unchained</a> on <a href="https://medium.com/p/8744d4d2bc3f"><time class="dt-published" datetime="2018-02-23T01:55:46.960Z">February 23, 2018</time></a>.</p><p><a href="https://medium.com/@chjango/the-internet-of-blockchains-how-cosmos-does-interoperability-starting-with-the-ethereum-peg-zone-8744d4d2bc3f" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on April 23, 2018.</p></footer></article>

</body></html>